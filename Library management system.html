<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Library Management System</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<style>
    /* Custom styles */
    body {
        background: #f9f9f9;
        color: #333;
        scroll-behavior: smooth;
        padding-top: 56px; /* Offset for fixed navbar */
        font-family: 'Poppins', sans-serif;
    }
    a {
        text-decoration: none;
    }
    .card-icon {
        width: 40px;
        display: block;
        margin: 0 auto 10px;
    }
    .book-cover-sm {
        width: 45px;
        height: 65px;
        object-fit: cover;
        border-radius: 4px;
    }
    /* Ensure sections have enough padding */
    section {
        padding: 60px 0;
    }
    /* Simple message box */
    #message {
        margin-top: 12px;
        font-weight: bold;
    }
</style>
</head>
<body>

<!-- Bootstrap Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#overview">Library System</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Home</a> <!-- Points to landing page -->
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#catalog">Catalog</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="#dashboard">Dashboard</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#contact">Contact</a>
        </li>
        <li class="nav-item">
          <button id="logoutBtn" class="btn btn-outline-light btn-sm mt-1 mt-lg-0 ms-lg-2">Logout</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Overview Section -->
<section id="overview" class="py-5">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <h2 class="display-5">System Overview</h2>
        <p class="lead">This system is designed to facilitate easy management of books and users in a library. Administrators and students can access their respective functionalities through the login system.</p>
      </div>
      <div class="col-lg-6 mt-4 mt-lg-0">
        <img src="library.jpeg" class="img-fluid rounded shadow" alt="Library Banner">
      </div>
    </div>
  </div>
</section>

<!-- Dashboard Section -->
<section id="dashboard" class="bg-light py-5">
  <div class="container">
    <h2 class="text-center mb-4">Dashboard</h2>
    
    <!-- Dashboard Stats Cards -->
    <div class="row g-4 text-center">
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <img class="card-icon" src="total b.jpeg" alt="Books Icon">
            <h3 class="h5">Total Books</h3>
            <p class="h2 fw-bold">120</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <img class="card-icon" src="issue b.jpeg" alt="Issued Icon">
            <h3 class="h5">Issued Books</h3>
            <p class="h2 fw-bold">45</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <img class="card-icon" src="avai b.jpeg" alt="Available Icon">
            <h3 class="h5">Available Books</h3>
            <p class="h2 fw-bold">75</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin/Logged-in User Area -->
    <div id="adminArea" class="mt-5" style="display: none;"> <!-- Hidden by default -->
        <h3 class="text-center">Admin Controls</h3>
        <!-- Simple place for messages -->
        <div id="message" class="text-center"></div>
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- ADD BOOK FORM -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h4 class="card-title">Add New Book</h4>
                        <form id="addBookForm">
                            <div class="mb-3">
                                <label for="bookTitle" class="form-label">Book Title</label>
                                <input id="bookTitle" class="form-control" placeholder="Book Title" required />
                            </div>
                            <div class="mb-3">
                                <label for="bookAuthor" class="form-label">Author</label>
                                <input id="bookAuthor" class="form-control" placeholder="Author" required />
                            </div>
                            <button type="submit" class="btn btn-primary">Add Book</button>
                        </form>
                    </div>
                </div>

                <!-- Table to list books from Firestore -->
                <h4 class="text-center mt-4">Database Book List</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr><th>ID</th><th>Title</th><th>Author</th><th>Status</th></tr>
                        </thead>
                        <tbody id="dbBookTableBody">
                            <!-- Rows will be added by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recently Issued Books (Static) -->
    <h3 class="text-center mt-5 mb-3">Recently Issued Books</h3>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr><th>Cover</th><th>Title</th><th>Issued To</th></tr>
        </thead>
        <tbody>
          <tr><td><img class="book-cover-sm" src="hp1.jpeg"></td><td>Harry Potter and the Sorcerer's Stone</td><td>Jayanth</td></tr>
          <tr><td><img class="book-cover-sm" src="hobbit.jpeg"></td><td>The Hobbit</td><td>Roshini</td></tr>
          <tr><td><img class="book-cover-sm" src="cc.jpeg"></td><td>Clean Code</td><td>Sumathiran</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</section>

<!-- Catalog Section -->
<section id="catalog" class="py-5">
  <div class="container">
    <h2 class="text-center mb-4">Book Catalog</h2>
    <div class="row mb-3">
      <div class="col-md-6 mx-auto">
        <input type="text" id="searchInput" class="form-control" placeholder="Search static catalog..." onkeyup="searchBooks()">
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle" id="staticBookTable">
        <thead class="table-dark">
          <tr><th>Cover</th><th>ID</th><th>Title</th><th>Author</th><th>Status</th></tr>
        </thead>
        <tbody>
          <tr><td><img class="book-cover-sm" src="hp1.jpeg"></td><td>001</td><td>Harry Potter and the Sorcerer's Stone</td><td>J.K. Rowling</td><td>Available</td></tr>
          <tr><td><img class="book-cover-sm" src="hp2.jpeg"></td><td>002</td><td>Harry Potter and the Chamber of Secrets</td><td>J.K. Rowling</td><td>Issued</td></tr>
          <tr><td><img class="book-cover-sm" src="lotr.jpeg"></td><td>003</td><td>The Fellowship of the Ring</td><td>J.R.R. Tolkien</td><td>Available</td></tr>
          <tr><td><img class="book-cover-sm" src="lotr 1.jpeg"></td><td>004</td><td>The Two Towers</td><td>J.R.R. Tolkien</td><td>Available</td></tr>
          <tr><td><img class="book-cover-sm" src="lotr 2.jpeg"></td><td>005</td><td>The Return of the King</td><td>J.R.R. Tolkien</td><td>Issued</td></tr>
          <tr><td><img class="book-cover-sm" src="cc.jpeg"></td><td>006</td><td>Clean Code</td><td>Robert Martin</td><td>Available</td></tr>
          <!-- Add more static rows as needed -->
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Contact Section -->
<section id="contact" class="bg-light py-5">
  <div class="container">
    <h2 class="text-center mb-4">Contact Us</h2>
    <div class="row">
      <div class="col-md-8 col-lg-6 mx-auto">
        <div class="card shadow-sm">
          <div class="card-body p-4 p-md-5">
            <img src="contact.jpeg" class="rounded-circle d-block mx-auto mb-3" alt="Contact Icon">
            <form>
              <div class="mb-3">
                <label for="contactName" class="form-label">Name</label>
                <input type="text" class="form-control" id="contactName" placeholder="Your Name" required>
              </div>
              <div class="mb-3">
                <label for="contactEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="contactEmail" placeholder="Your Email" required>
              </div>
              <div class="mb-3">
                <label for="contactMessage" class="form-label">Message</label>
                <textarea class="form-control" id="contactMessage" rows="4" placeholder="Your Message..." required></textarea>
              </div>
              <button type="submit" class="btn btn-primary w-100">Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="text-center py-4 bg-dark text-white">
  <div class="container">
    <p class="mb-0">&copy; 2025 Library Management System</p>
  </div>
</footer>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDWsp-NJWXrNOIBJjCzo62MjJ2v105WStU",
    authDomain: "library-management-9169b.firebaseapp.com",
    projectId: "library-management-9169b",
    storageBucket: "library-management-9169b.firebasestorage.app",
    messagingSenderId: "984877351075",
    appId: "1:984877351075:web:4b4bc70849bec17106ff16"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // Firebase services
  const auth = firebase.auth();
  const db = firebase.firestore();

  // DOM Refs
  const logoutBtn = document.getElementById('logoutBtn');
  const adminArea = document.getElementById('adminArea');
  const addBookForm = document.getElementById('addBookForm');

  // --- Utility Functions ---
  const showMsg = (text, isError=false) => {
    const el = document.getElementById('message');
    el.className = isError ? 'text-danger' : 'text-success';
    el.textContent = text;
    if (!isError) setTimeout(()=> el.textContent='', 4000);
  };

  function escapeHtml(str) {
    return String(str).replace(/[&<>"'`=\/]/g, s => {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s];
    });
  }

  // --- Auth Management ---
  
  // AUTH STATE OBSERVER
  // This page is protected. If no user, redirect to login.html.
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      // User is signed in, load dynamic content
      adminArea.style.display = 'block';
      loadBooks(); // Load books from DB
    } else {
      // User is signed out, redirect to login page
      window.location.href = 'login.html';
    }
  });

  // LOGOUT
  logoutBtn.addEventListener('click', async () => {
    try {
      await auth.signOut();
      // Redirect to the main landing page
      window.location.href = 'index.html';
    } catch (err) {
      showMsg('Logout error: ' + err.message, true);
    }
  });

  // --- Firestore Book Management ---

  // ADD BOOK
  addBookForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = document.getElementById('bookTitle').value.trim();
    const author = document.getElementById('bookAuthor').value.trim();
    if (!title || !author) { 
      showMsg('Please fill in both title and author.', true); 
      return; 
    }

    const user = auth.currentUser;
    if (!user) return; 

    try {
      await db.collection('books').add({
        title,
        author,
        createdBy: user.uid,
        status: 'available',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      showMsg('Book added successfully!');
      addBookForm.reset();
    } catch (err) {
      showMsg('Error adding book: ' + err.message, true);
    }
  });

  // LOAD BOOKS (REALTIME)
  function loadBooks() {
    const tbody = document.getElementById('dbBookTableBody');
    tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
    
    // Using onSnapshot for real-time updates
    db.collection('books').orderBy('createdAt', 'desc').limit(100).onSnapshot(snapshot => {
      if (snapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="4">No books found in database.</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(doc.id.substring(0, 8))}...</td>
          <td>${escapeHtml(data.title || '')}</td>
          <td>${escapeHtml(data.author || '')}</td>
          <td><span class="badge bg-success">${escapeHtml(data.status || 'available')}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }, (err) => {
       tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Error loading books: ${escapeHtml(err.message)}</td></tr>`;
    });
  }

  // --- Page JavaScript ---
  
  // Search for STATIC table
  function searchBooks() {
    let input = document.getElementById('searchInput').value.toLowerCase();
    let rows = document.querySelectorAll('#staticBookTable tbody tr');
    rows.forEach(row => {
      let text = row.textContent.toLowerCase();
      row.style.display = text.includes(input) ? '' : 'none';
    });
  }

  // Activate nav links on scroll
  const sections = document.querySelectorAll('section');
  const navLi = document.querySelectorAll('.navbar-nav .nav-item .nav-link');

  window.addEventListener('scroll', ()=> {
    let current = 'overview'; 
    sections.forEach( section => {
      const sectionTop = section.offsetTop;
      if (pageYOffset >= (sectionTop - 60)) { 
        current = section.getAttribute('id');
      }
    });

    navLi.forEach( a => {
      a.classList.remove('active', 'fw-bold');
      const href = a.getAttribute('href');
      // Check for anchor links
      if (href && href.startsWith('#') && href.substring(1) === current) {
        a.classList.add('active', 'fw-bold');
      } 
    });
    // Ensure dashboard is active if at top
    if (window.pageYOffset < 200) {
        document.querySelector('.nav-link[href="#dashboard"]').classList.add('active', 'fw-bold');
    }
  });

</script>

</body>
</html>
